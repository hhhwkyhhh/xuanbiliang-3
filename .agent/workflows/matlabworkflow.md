---
description: MATLAB & Simulink MCP 协作工作流规范 (Antigravity Protocol)
---

# MATLAB & Simulink MCP 协作工作流规范 (Antigravity Protocol)

本规范定义了 Antigravity 与人类用户在使用 MATLAB MCP 环境进行 Simulink 项目开发时的标准协作流程与行为准则。

## 1. 核心协作原则

- **MCP 优先**：所有 MATLAB/Simulink 相关交互优先走 MCP 通道，确保环境持久化和状态共享。
- **人机分工**：
  - **M 代码层**：Agent 主导（编写、自动运行、检查）。
  - **Simulink 运行层**：人类主导（GUI交互、波形监视、报错反馈）。
  - **Simulink 结构层**：共同维护（Agent 解压分析源码，人类操作 GUI 编辑）。
- **Token 节约原则**：
  - Agent 在使用 MCP 查询工作区时，应避免直接 `disp()` 大型矩阵。优先使用 `size()`, `whos`, `class()` 等轻量级命令，或通过绘图间接验证数据正确性。

## 2. `.m` 脚本处理规范 (M-Files)

- **自动化管理**：
  - Agent 负责创建、编辑和运行 `.m` 脚本。
  - 使用 `mcp_matlab_run_matlab_file` 或 `evaluate_code` 执行代码。
- **质量门禁**：
  - 代码运行前，Agent 必须自行规划逻辑。
  - 代码运行后，Agent 必须**主动检查工作区变量**（特别是矩阵维度 `size`、数据类型 `class`），确保符合 Simulink 模型对输入数据的要求，严禁“盲跑”。
- **可视化验证**：
  - 涉及数据分析时，Agent 应主动绘制 Figure 图表，供用户在 MATLAB 界面确认。
- **启动依赖管理**：
  - Agent 在首次准备运行模型时，必须先分析模型依赖的工作区变量（可通过解压快照或用户说明获取），并编写/运行初始化 M 脚本确保这些变量已定义。

## 3. `.slx` 模型理解与更新规范 (SLX-Files)

- **解压即源码 (Unzip as Source)**：
  - Agent 不依赖不稳定的 API 遍历模型，而是通过解压 `.slx` 文件直接读取 XML 描述文件（如 `simulink/blockdiagram.xml`）来理解模型结构。
- **快照生命周期管理**：
  - **建立基准**：用户指令“理解模型”时，Agent 解压模型到 `[model_name]_extract` 文件夹，并**保留**该文件夹作为初始参考。
  - **动态追踪 (Active Tracking)**：解压文件夹仅视为“上一次同步时的快照”。在对话过程中，若涉及对 SLX 内部（特别是 MATLAB Function 模块）的逻辑修改，Agent 必须在内存/上下文中**实时更新并记忆**这些变更。Agent 必须以**当前对话中最新确认的代码状态**为准进行推理，不能死板地引用文件夹里的旧版本。
  - **MATLAB Function 模块特别关注**：
    - Agent 应特别关注 SLX 内嵌的 MATLAB Function 代码（通常位于 `simulink/stateflow/` 或 XML 数据段）。
    - 在对话中若用户描述了对该代码的修改，Agent 必须在上下文中记录"该函数当前的逻辑"，并以此为准进行后续推理。
  - **手动同步**：当修改积累到一定程度或需要彻底刷新结构认知时，由用户发出指令（触发词：`"更新slx文件夹"`, `"刷新模型快照"`, `"重新解压模型"`），Agent 执行 **删除旧文件夹 -> 重新解压新 SLX** 的操作来物理同步最新状态。

## 4. 仿真与调试流程 (Simulation loop)

- **运行权移交**：
  - 简单非可视化仿真（如仅需数据）：可由 Agent 通过 MCP `sim()` 尝试运行。
  - **标准仿真流程**：由用户在 Simulink 图形界面手动点击运行，以便实时观测 Scope 波形。
- **报错处理 (Error Handling)**：
  - **Agent 捕获**：对于 MCP 可捕获的简单错误（如参数未定义），Agent 自动尝试修复。
  - **人类反馈**：对于级联错误或复杂诊断，用户负责将 Diagnostic Viewer 中的完整红字报错信息复制给 Agent。
  - **可观测性**：Agent 遇到“数据不对”的情况，应主动请求用户提供界面截图或特定 Scope 的数据导出。
  - **主动提问责任**：
    - Agent 若判断信息不足以做出准确修复（如报错信息模糊、需要看波形趋势等），必须主动向用户请求：Scope 截图、特定变量值或模型局部截图。
## 5.  方案文档存放规则

当用户请求生成修改方案、实施计划、修改指南等详细文档时：

1. **存放位置**：所有方案文档必须保存在项目目录下的 `方案/` 文件夹中
2. **文件格式**：使用 Markdown (.md) 格式
3. **命名规范**：使用中文描述性名称，如 `修改频率分辨率方案.md`、`SLX_MATLAB_Function修改指南.md`
4. **优先创建文件**：对于详细方案（超过 50 行），优先创建 MD 文件而非在对话框中展示，以节省上下文 token

**适用文档类型**：
- 修改方案
- 实施计划
- 代码审查提示词
- 配置指南
- 问题修复指南